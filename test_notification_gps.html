<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notification with GPS Location</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .gps-section {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .gps-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #2196F3;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        .response {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìç Test Notification with GPS Location</h1>
        
        <div class="gps-section">
            <h3>üåç GPS Location Detection</h3>
            <p>This form will automatically detect your device's GPS location and include it in the notification.</p>
            <button id="getLocationBtn" onclick="getCurrentLocation()">Get My Location</button>
            <button id="useManualBtn" onclick="useManualLocation()">Use Manual Location</button>
            
            <div id="locationInfo" class="gps-info" style="display: none;">
                <strong>Current Location:</strong><br>
                <span id="locationText">Loading...</span>
            </div>
        </div>

        <form id="notificationForm">
            <div class="form-group">
                <label for="near_rib">Near RIB Station:</label>
                <select id="near_rib" name="near_rib" required>
                    <option value="">Select RIB Station</option>
                    <option value="1234567890123456">RIB Station 1</option>
                    <option value="1234567890123457">RIB Station 2</option>
                    <option value="1234567890123458">RIB Station 3</option>
                </select>
            </div>

            <div class="form-group">
                <label for="fullname">Full Name:</label>
                <input type="text" id="fullname" name="fullname" required placeholder="Enter full name">
            </div>

            <div class="form-group">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" placeholder="Enter address">
            </div>

            <div class="form-group">
                <label for="phone">Phone Number:</label>
                <input type="tel" id="phone" name="phone" placeholder="Enter phone number">
            </div>

            <div class="form-group">
                <label for="message">Message:</label>
                <textarea id="message" name="message" required placeholder="Enter your message about the sinner"></textarea>
            </div>

            <!-- Hidden fields for GPS coordinates -->
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">
            <input type="hidden" id="location_name" name="location_name">

            <button type="submit" id="submitBtn">Send Notification with GPS</button>
        </form>

        <div id="result"></div>
    </div>

    <script>
        let currentLocation = null;

        function getCurrentLocation() {
            const locationInfo = document.getElementById('locationInfo');
            const locationText = document.getElementById('locationText');
            const getLocationBtn = document.getElementById('getLocationBtn');
            
            getLocationBtn.disabled = true;
            getLocationBtn.textContent = 'Getting Location...';
            locationText.textContent = 'Requesting location permission...';

            if (!navigator.geolocation) {
                showError('Geolocation is not supported by this browser.');
                getLocationBtn.disabled = false;
                getLocationBtn.textContent = 'Get My Location';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };

                    // Update form fields
                    document.getElementById('latitude').value = currentLocation.latitude;
                    document.getElementById('longitude').value = currentLocation.longitude;
                    document.getElementById('location_name').value = `GPS Location (Accuracy: ${Math.round(currentLocation.accuracy)}m)`;

                    // Show location info
                    locationText.innerHTML = `
                        <strong>Latitude:</strong> ${currentLocation.latitude.toFixed(6)}<br>
                        <strong>Longitude:</strong> ${currentLocation.longitude.toFixed(6)}<br>
                        <strong>Accuracy:</strong> ${Math.round(currentLocation.accuracy)} meters<br>
                        <strong>Status:</strong> ‚úÖ GPS location captured successfully
                    `;
                    locationInfo.style.display = 'block';

                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'Get My Location';
                    showSuccess('GPS location captured successfully!');
                },
                function(error) {
                    let errorMessage = 'Error getting location: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Permission denied by user.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                        default:
                            errorMessage += 'Unknown error occurred.';
                            break;
                    }
                    showError(errorMessage);
                    getLocationBtn.disabled = false;
                    getLocationBtn.textContent = 'Get My Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        function useManualLocation() {
            const latitude = prompt('Enter latitude (e.g., -1.9441):');
            const longitude = prompt('Enter longitude (e.g., 30.0619):');
            const locationName = prompt('Enter location name (e.g., Kigali, Rwanda):');

            if (latitude && longitude) {
                currentLocation = {
                    latitude: parseFloat(latitude),
                    longitude: parseFloat(longitude),
                    accuracy: 0
                };

                // Update form fields
                document.getElementById('latitude').value = currentLocation.latitude;
                document.getElementById('longitude').value = currentLocation.longitude;
                document.getElementById('location_name').value = locationName || 'Manual Location';

                // Show location info
                const locationText = document.getElementById('locationText');
                locationText.innerHTML = `
                    <strong>Latitude:</strong> ${currentLocation.latitude}<br>
                    <strong>Longitude:</strong> ${currentLocation.longitude}<br>
                    <strong>Location:</strong> ${locationName || 'Manual Location'}<br>
                    <strong>Status:</strong> ‚úÖ Manual location set
                `;
                document.getElementById('locationInfo').style.display = 'block';

                showSuccess('Manual location set successfully!');
            }
        }

        function showSuccess(message) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="success">${message}</div>`;
        }

        function showError(message) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="error">${message}</div>`;
        }

        function showResponse(data) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="response">${JSON.stringify(data, null, 2)}</div>`;
        }

        document.getElementById('notificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/v1/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Notification sent successfully with GPS location!');
                    showResponse(result);
                } else {
                    showError('Failed to send notification: ' + result.message);
                    showResponse(result);
                }
            } catch (error) {
                showError('Error sending notification: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Notification with GPS';
            }
        });

        // Auto-get location on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (confirm('Would you like to automatically get your current location for the notification?')) {
                    getCurrentLocation();
                }
            }, 1000);
        });
    </script>
</body>
</html>
